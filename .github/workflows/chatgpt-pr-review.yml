name: ChatGPT PR Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Extract diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff origin/${{ github.base_ref }} > pr_diff.txt

      - name: Call ChatGPT for review
        id: chatgpt
        run: |
          DIFF_CONTENT=$(sed 's/"/\\"/g' pr_diff.txt)
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"Eres un revisor de código experto en R, proyectos de datos y buenas prácticas de ingeniería de software. Da comentarios claros, críticos, constructivos y concretos.\"},
                {\"role\": \"user\", \"content\": \"Aquí tienes el diff de un Pull Request. Por favor revisa y comenta aspectos de claridad, rendimiento, estilo, modularidad, posibles errores y mejoras:\n\n$DIFF_CONTENT\"}
              ],
              \"temperature\": 0.2
            }" | jq -r '.choices[0].message.content')
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: "ChatGPT Review"
          message: ${{ steps.chatgpt.outputs.review }}
